---
title: "Vessel activity"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 10, fig.height = 7, warning = F)
library(ggplot2)
library(ggforce)
library(magrittr)
library(tidyverse)
```

Here we look, on a high level, at the tracks data used to determine vessel activity. As well as the results from the vessel activity coefficient modelling.

## Summary

* There are multiple issues with the trip detection algorithm and device operation that could affect the activity estimates. Until these issues are resolved, activity estimates should be seen as provisional. 
* Sampling is currently insufficient to reliable report activity estimates at the municipality level, but is to-date enough to paint a picture at the national level with certain confidence. 
* Canoe boats are under-represented from tracking. About 40% of trackers devices have been installed in canoes, but they constitute about 70% of the fishing fleet. The disparity is larger in some municipalities. 
* The number of operational tracking units is steadily declining. Sampling in some locations for at least one boat type is already nil. At the current rate, without new trackers added, the ability to generate activity estimates at the national level might be severely compromised in 1 to 3 years time. 
* There are large gaps in data availability in tracking data. The origin of this gaps is unknown and until we know more about it, it may call to question the reliability of the service.
* Significant number of boat trackers stopped being operational (last heard off) simultaneously. These events are prominent at the beginning of the first quarter 2019 and the beginning of the second quarter 2020. The reason for this decline is currently unknown and warrants further investigation of the failure rate of tracking devices. 
* New devices should be deployed aiming to improve covering of under-sampled municipalities and boat types. 
* The tracking data highlights some potential inaccuracies with the fisher/boat counts per municipality. In one of the locations the number of tracking devices installed is larger than the recorded number of boats. 
* Substantial improvements in the PDS detection algorithm or sufficient post-processing methods are needed before it can be used ready for fisher-level analytics. 
* Generating confidence intervals will be crucial to better understand the accuracy of the estimates.

## Plots

```{r operation-per-boat, fig.height=10}
drake::loadd(vessel_activity_bernoulli)

vessel_activity_bernoulli %>%
  group_by(imei, boat_id_pds, boat_code, municipality_name) %>%
  summarise(installation = min(trip_end_date_pds), 
            last_heard = max(trip_end_date_pds), .groups = "drop") %>%
  mutate(boat_id_pds = fct_reorder(boat_id_pds, installation, .fun = min, .desc = T),
         municipality_name = fct_reorder(municipality_name, installation, .fun = min, .desc = F)) %>%
  ggplot(aes(y = boat_id_pds, colour = boat_code)) +
  geom_segment(aes(x = installation, xend = last_heard, yend = boat_id_pds)) +
  facet_grid(municipality_name ~ ., scales = "free", space = "free", margins = F) +
  scale_color_brewer(palette = "Pastel1", labels = c("Canoe", "Motor"), name = "Boat type") +
  theme_minimal() +
  theme(axis.text.y = element_blank(), 
        panel.grid.major.y = element_blank(), 
        legend.position = "top", 
        axis.title.x = element_blank()) +
  labs(title = "Operation time for installed PDS trackers in Timor", 
       caption = "Operation time goes from the time of first trip until the time the tracker was last detected",
       legend = "Boat type",
       y = "Individual boat")
  
```

```{r operation-all-boats, fig.height=5}
vessel_activity_bernoulli %>%
  complete(period_static, boat_code) %>%
  group_by(period_static, boat_code) %>%
  summarise(n_boats = n_distinct(boat_id_pds, na.rm = T), .groups = "drop") %>%
  mutate(boat_code = fct_reorder(boat_code, n_boats)) %>%
  ggplot(aes(x = period_static, y = n_boats, fill = boat_code)) +
  geom_col() +
  theme_minimal() +
  scale_fill_brewer(palette = "Pastel1", labels = c("Canoe", "Motor"), name = "Boat type") +
  labs(title = "Number of boats tracked")
```

```{r operation-per-location , fig.height=15}
drake::loadd(peskadat_municipalities)

census <- peskadat_municipalities %>%
  select(-fishers) %>%
  pivot_longer(c(canoes, motors), "boat_code") %>%
  mutate(boat_code = case_when(boat_code == "canoes" ~ "1", 
                               boat_code == "motors" ~ "2"))

boats_location_data <-vessel_activity_bernoulli %>%
  complete(municipality_name, period_static, boat_code) %>%
  group_by(municipality_name, period_static, boat_code) %>%
  summarise(n_boats = n_distinct(boat_id_pds, na.rm = T), .groups = "drop") %>%
  left_join(census, by = c("municipality_name", "boat_code")) %>%
  mutate(prop_boats = n_boats / value, 
         municipality_name = fct_reorder(municipality_name, n_boats,.fun = max, .desc = T))

proportion_plot <- boats_location_data %>%
  ggplot(aes(x = period_static, y = prop_boats, colour = boat_code)) +
  geom_step() +
  scale_y_continuous(labels = scales::percent) +
  facet_wrap("municipality_name", ncol = 1, scales = "free") +
  scale_colour_brewer(palette = "Pastel1", labels = c("Canoe", "Motor"), name = "Boat type") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(title = "Proportion of boats tracked")

count_plot <- boats_location_data %>%
  ggplot(aes(x = period_static, y = n_boats, fill = boat_code)) +
  geom_col() +
  facet_wrap("municipality_name", ncol = 1, scales = "free") +
  scale_fill_brewer(palette = "Pastel1", labels = c("Canoe", "Motor"), name = "Boat type") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(title = "Number of boats tracked")

cowplot::plot_grid(count_plot, proportion_plot, ncol = 2)

```

```{r model-predictions}
drake::loadd(vessel_activity_model)

extract_weekly_data <- function(x){
  nd <- x@frame %>%
    distinct(municipality_name, period_static) %>%
    mutate(data_available = TRUE) %>%
    complete(municipality_name, period_static = full_seq(period_static, period = 7), 
             fill = list(data_available = FALSE)) %>%
    mutate(period_seasonal = lubridate::week(period_static))
}

predict_weekly_vac <- function(x, nd, out = "numeric"){
  
  y = predict(x, newdata = nd,
          re.form = ~ (1 | municipality_name) + (1 | period_static) +
            (1 | municipality_name : period_static) + (1 | period_seasonal),
          allow.new.levels = T)
  
  if (out == "numeric") {
    return(y)
  }
  
  nd %>%
    mutate(estimate = y)
}

vac_predic_data <- vessel_activity_model %>%
  map(extract_weekly_data) 

map2_dfr(vessel_activity_model, vac_predic_data, predict_weekly_vac, out = "df", .id = "boat_type") %>%
  ggplot(aes(x = period_static, y = plogis(estimate))) +
  geom_link2(aes(alpha = data_available, group = boat_type, 
                 colour = boat_type)) +
  scale_linetype_manual(values = c(2,1)) +
  scale_alpha_manual(values = c(0.4, 1)) +
  scale_colour_brewer(palette = "Set1", labels = c("Canoe", "Motor"), name = "Boat type") +
  facet_wrap(~municipality_name) +
  theme_minimal() +
  labs(title = "Vessel activity coefficient in Timor", 
       caption = "Ligter colour indicates that no sampling was performed during that period at that particular location")

# predict_weekly <- function(x){
#   predict_weekly_vac(x, extract_weekly_data(x))
# }
# 
# system.time({
#   a <- bootMer(vessel_activity_model[[1]],
#              FUN = predict_weekly,
#              seed = 123, nsim = 4, parallel = "multicore", ncpus = 4)
# })
# 
# 
# predict_data_temp <- vac_predic_data[[1]] %>%
#   mutate(prediction = as.character(1:n()))
#   
# as_tibble(a) %>%
#   mutate(sample = 1:n()) %>%
#    pivot_longer(-sample, values_to = "estimate", names_to = "prediction") %>%
#   right_join(predict_data_temp)%>%
#   ggplot(aes(x = period_static, y = plogis(estimate))) +
#   geom_link2(aes(alpha = data_available, group = sample)) +
#   scale_linetype_manual(values = c(2,1)) +
#   scale_alpha_manual(values = c(0.4, 1)) +
#   scale_colour_brewer(palette = "Set1", labels = c("Canoe", "Motor"), name = "Boat type") +
#   facet_wrap(~municipality_name) +
#   theme_minimal()

```

